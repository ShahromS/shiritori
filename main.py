import random
from flask import Flask, request, jsonify

app = Flask(__name__)

# –°–ø–∏—Å–æ–∫ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤ (–≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
used_words = set()

# –ë–∞–∑–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤ –¥–ª—è „Åó„Çä„Å®„Çä
word_list = ["„Çä„Çì„Åî", "„Åî„Åæ", "„Åæ„ÇÅ", "„ÇÅ„Åå„Å≠", "„Å≠„Åì", "„Åì„Åæ", "„Åæ„Çä", "„Çä„Åô"]


def get_next_word(last_char):
    """
    –í—ã–±–∏—Ä–∞–µ—Ç —Å–ª–æ–≤–æ, –Ω–∞—á–∏–Ω–∞—é—â–µ–µ—Å—è –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –±—É–∫–≤—É, 
    –∫–æ—Ç–æ—Ä–æ–µ –µ—â—ë –Ω–µ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ.
    """
    candidates = [
        word for word in word_list
        if word.startswith(last_char) and word not in used_words
    ]
    return random.choice(candidates) if candidates else None


@app.route("/", methods=["POST"])
def webhook():
    global used_words

    data = request.get_json(silent=True, force=True)
    if not data:
        return jsonify({"fulfillmentText": "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç DialogFlow."})

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ Intenta, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –∫–∞–∫–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—Å–∫–∞—Ç—å
    intent_name = data.get("queryResult", {}).get("intent", {}).get("displayName", "")

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö Intents –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç intent_name
    if intent_name == "Default Welcome Intent":
        # –ü—Ä–æ—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        return jsonify(
            {"fulfillmentText": "–ü—Ä–∏–≤–µ—Ç! –Ø –≥–æ—Ç–æ–≤ —Å—ã–≥—Ä–∞—Ç—å –≤ „Åó„Çä„Å®„Çä. –°–∫–∞–∂–∏ '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É', —á—Ç–æ–±—ã —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å!"})

    elif intent_name == "StartShiritoriIntent":
        # –ù–∞—á–∏–Ω–∞–µ–º –∏–≥—Ä—É, —Å–±—Ä–∞—Å—ã–≤–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ –¥–∞—ë–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        used_words.clear()
        return jsonify({"fulfillmentText": "–ò–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è! –°–∫–∞–∂–∏ –ª—é–±–æ–µ —Å–ª–æ–≤–æ –Ω–∞ —è–ø–æ–Ω—Å–∫–æ–º, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å „Åó„Çä„Å®„Çä."})

    else:
        # –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã ‚Äî —á–∞—Å—Ç—å –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ „Åó„Çä„Å®„Çä
        user_word = data.get("queryResult", {}).get("queryText", "").strip()

        if not user_word:
            return jsonify({"fulfillmentText": "–Ø –Ω–µ —É—Å–ª—ã—à–∞–ª –æ—Ç —Ç–µ–±—è —Å–ª–æ–≤–∞. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞."})

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ —ç—Ç–æ —Å–ª–æ–≤–æ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ
        if user_word in used_words:
            return jsonify({"fulfillmentText": "–≠—Ç–æ —Å–ª–æ–≤–æ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ."})

        # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ
        used_words.add(user_word)

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –±—É–∫–≤—É
        last_char = user_word[-1]
        # –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ
        next_word = get_next_word(last_char)

        # –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–µ–µ —Å–ª–æ–≤–æ
        if next_word:
            used_words.add(next_word)
            return jsonify({"fulfillmentText": f"{next_word}ÔºÅ–¢–µ–ø–µ—Ä—å —Ç–≤–æ–π —Ö–æ–¥!"})
        else:
            # –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —Å–ª–æ–≤–∞
            return jsonify({"fulfillmentText": "–Ø –Ω–µ –º–æ–≥—É –ø—Ä–∏–¥—É–º–∞—Ç—å —Å–ª–æ–≤–æ... –¢—ã –ø–æ–±–µ–¥–∏–ª! üéâ"})


if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ 0.0.0.0:8080
    # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–ª–∏ —Ö–æ—Å—Ç —Å ngrok –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å —ç—Ç–æ—Ç –ø–æ—Ä—Ç
    app.run(host="0.0.0.0", port=8080)